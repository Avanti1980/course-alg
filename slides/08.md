---
presentation:
  margin: 0
  center: false
  transition: "convex"
  enableSpeakerNotes: true
  slideNumber: "c/t"
  navigationMode: "linear"
---

@import "../css/font-awesome-4.7.0/css/font-awesome.css"
@import "../css/theme/solarized.css"
@import "../css/logo.css"
@import "../css/font.css"
@import "../css/color.css"
@import "../css/margin.css"
@import "../css/table.css"
@import "../css/main.css"
@import "../plugin/zoom/zoom.js"
@import "../plugin/customcontrols/plugin.js"
@import "../plugin/customcontrols/style.css"
@import "../plugin/chalkboard/plugin.js"
@import "../plugin/chalkboard/style.css"
@import "../plugin/menu/menu.js"

<!-- slide id="front-page" data-notes="" -->

<div class="bottom20"></div>

# 算法设计与分析

<hr class="width70 center">

## 回溯法

<div class="bottom8"></div>

### 计算机学院 &nbsp;&nbsp; 张腾

#### _tengzhang@hust.edu.cn_

<!-- slide vertical=true data-notes="" -->

##### 课程大纲

---

@import "../vega/outline-backtracking.json" {as="vega" .top-2}

<!-- slide data-notes="" -->

##### 回溯法

---

有些问题要求在相对于输入规模呈指数增长的域中寻找特定元素

<div class="top-1"></div>

暴力穷举，检查所有的元素？时间开销难以承受

<div class="top2"></div>

回溯法：{==对暴力穷举法的改进==}，{==带剪枝的搜索==}

<div class="top-1"></div>

基本思路：将解表示成{==元组==}的形式，依次构建其分量，当构建完某个分量后发现之后的分量无论怎么构建都不可能得到一个解，就提早回头，谨防一条道走到黑

<div class="top2"></div>

最坏情况下依然和暴力穷举法有同样的时间复杂度！

<div class="top-1"></div>

但是对某些组合难题，可以求解其较大实例

<!-- slide data-notes="" -->

##### <span style="font-weight:900">n</span>-皇后问题

---

在 n × n 的棋盘上放置 n 个皇后，使得任意两个皇后都不能互相攻击：不在同一行、同一列或同一条斜角线上

<div class="top-3 tighttable row1-8-column2-9-fullborder row1-8-column13-20-fullborder queen8-base2">

| &zwnj; |   1    |   2    |   3    |   4    |   5    |   6    |   7    |   8    | &zwnj; | &zwnj; | &zwnj; |   1    |   2    |   3    |   4    |   5    |   6    |   7    |   8    |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|   1    | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   1    | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   2    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   2    | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; |
|   3    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; |   3    | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   4    | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   4    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   |
|   5    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; |   5    |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   6    |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   6    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; |
|   7    | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   7    | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   8    | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   8    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; |

</div>

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题初试

---

@import "../dot/four-queen.dot" {.center .top-8}

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">n</span>-皇后问题

---

皇后编号：$1, \ldots, n$，不失一般性，约定皇后$i$放在第$i$行

{==解的表示==}：$n$-元组$(x_1, \ldots, x_n)$，其中$x_i$是皇后$i$所在列号

显式约束条件：$x_i \in \{1, \ldots, n\}$

解空间：所有可能的$n$元组，共有$n^n$个

隐式约束条件：没有两个$x_i$相同，没有两个皇后在同一条斜角线上，即对任意$i \ne j$有$|x_i - x_j| \ne |i - j|$

由隐式约束条件可知可能的解只能是$\{1, \ldots, n\}$的置换 (排列)，最多有$n!$个

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">n</span>-皇后问题

---

<div class="top-3 tighttable row1-8-column2-9-fullborder row1-8-column13-20-fullborder queen8-base2">

| &zwnj; |   1    |   2    |   3    |   4    |   5    |   6    |   7    |   8    | &zwnj; | &zwnj; | &zwnj; |   1    |   2    |   3    |   4    |   5    |   6    |   7    |   8    |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|   1    | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   1    | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   2    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   2    | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; |
|   3    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; |   3    | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   4    | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   4    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   |
|   5    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; |   5    |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   6    |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   6    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; |
|   7    | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   7    | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; |
|   8    | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   8    | &zwnj; | &zwnj; | &zwnj; | &zwnj; | &zwnj; |   👑   | &zwnj; | &zwnj; |

</div>

两个解分别是$(4, 6, 8, 2, 7, 1, 3, 5)$、$(3, 5, 2, 8, 1, 7, 4, 6)$

<!-- slide data-notes="" -->

##### 解空间的组织

---

回溯法系统检查问题的解空间来求解，不遗漏不重复

{==状态空间树==}：每个结点对应一个棋盘状态

- 根结点代表查找解之前的初始状态
- 第一层结点代表对解的第一个分量所做的选择
- 第二层结点代表对解的第二个分量所做的选择
- ……

<!-- slide vertical=true data-notes="" -->

##### 状态空间树 无剪枝

---

@import "../dot/four-queen-solution-space.dot" {.center .top0}

<div class="top0"></div>

第$i$层的边上数字$j$表示将皇后$i$放到第$j$列

<div class="top-2"></div>

$24$个叶结点对应$4! = 24$个解

<!-- slide vertical=true data-notes="" -->

##### 状态空间树 剪枝

---

{==限界函数==}：对应问题的约束，用来杀死不满足约束的结点

三类结点

- {==活结点==}：自己已经生成，但子结点还没全部生成并且有待生成
- {==E-结点==}：当前正在生成其子结点的活结点
- {==死结点==}：被限界函数杀死或者其子结点已全部生成的结点

<div class="top2"></div>

两种策略：

- {==深度优先==}：对应{==回溯==}，当 E-结点 R 一旦生成一个新的儿子 C 时，C 就变成了新的 E-结点，当完全检测了子树 C 之后，R 结点再次成为 E-结点
- {==宽度优先==}：对应{==分支限界==}，一个 E-结点一直保持到变成死结点为止

<!-- slide data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题 回溯求解

---

{==解的表示==}：$4$-元组$(x_1, \ldots, x_4)$，其中$x_i$是皇后$i$所在列号

限界函数：设$(x_1, \ldots, x_{i-1})$是到当前 E-结点的路径，那么满足限界函数的$x_i$使得$(x_1, \ldots, x_{i-1}, x_i)$表示没有两个皇后可相互攻击的棋盘状态

初始状态：根结点 1，空棋盘

结点生成：依次考察各个皇后的位置

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题 回溯求解

---

<div class="top-3 tighttable row1-4-column2-5-fullborder row1-4-column8-11-fullborder row1-4-column14-17-fullborder queen4-base2">

| &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|   1    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   1    |   👑   | &ensp; | &ensp; | &ensp; | &ensp; |   1    |   👑   | &ensp; | &ensp; | &ensp; |
|   2    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   2    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   2    | &ensp; |   👑   | &ensp; | &ensp; |
|   3    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   3    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   3    | &ensp; | &ensp; | &ensp; | &ensp; |
|   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; |

</div>

@import "../dot/four-queen-solve1.dot" {.left27 .top0}

<div class="top-8"></div>

结点 3 的两个皇后在同一个斜角线

杀死结点 3，返回结点 2 继续扩展

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题 回溯求解

---

<div class="top-3 tighttable row1-4-column2-5-fullborder row1-4-column8-11-fullborder row1-4-column14-17-fullborder queen4-base2">

| &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|   1    |   👑   | &ensp; | &ensp; | &ensp; | &ensp; |   1    |   👑   | &ensp; | &ensp; | &ensp; | &ensp; |   1    |   👑   | &ensp; | &ensp; | &ensp; |
|   2    | &ensp; | &ensp; |   👑   | &ensp; | &ensp; |   2    | &ensp; | &ensp; |   👑   | &ensp; | &ensp; |   2    | &ensp; | &ensp; |   👑   | &ensp; |
|   3    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   3    | &ensp; |   👑   | &ensp; | &ensp; | &ensp; |   3    | &ensp; | &ensp; | &ensp; |   👑   |
|   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; |

</div>

@import "../dot/four-queen-solve2.dot" {.left20per .top0}

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题 回溯求解

---

<div class="top-3 tighttable row1-4-column2-5-fullborder row1-4-column8-11-fullborder row1-4-column14-17-fullborder queen4-base2">

| &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|   1    |   👑   | &ensp; | &ensp; | &ensp; | &ensp; |   1    |   👑   | &ensp; | &ensp; | &ensp; | &ensp; |   1    |   👑   | &ensp; | &ensp; | &ensp; |
|   2    | &ensp; | &ensp; | &ensp; |   👑   | &ensp; |   2    | &ensp; | &ensp; | &ensp; |   👑   | &ensp; |   2    | &ensp; | &ensp; | &ensp; |   👑   |
|   3    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   3    | &ensp; |   👑   | &ensp; | &ensp; | &ensp; |   3    | &ensp; |   👑   | &ensp; | &ensp; |
|   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; |   👑   | &ensp; |

</div>

@import "../dot/four-queen-solve3.dot" {.left14per .top0}

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题 回溯求解

---

<div class="top-3 tighttable row1-4-column2-5-fullborder row1-4-column8-11-fullborder row1-4-column14-17-fullborder queen4-base2">

| &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|   1    | &ensp; |   👑   | &ensp; | &ensp; | &ensp; |   1    | &ensp; |   👑   | &ensp; | &ensp; | &ensp; |   1    | &ensp; |   👑   | &ensp; | &ensp; |
|   2    | &ensp; | &ensp; | &ensp; |   👑   | &ensp; |   2    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   2    |   👑   | &ensp; | &ensp; | &ensp; |
|   3    | &ensp; | &ensp; |   👑   | &ensp; | &ensp; |   3    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   3    | &ensp; | &ensp; | &ensp; | &ensp; |
|   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; |

</div>

@import "../dot/four-queen-solve4.dot" {.left16per .top0}

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题 回溯求解

---

<div class="top-3 tighttable row1-4-column2-5-fullborder row1-4-column8-11-fullborder row1-4-column14-17-fullborder queen4-base2">

| &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    | &ensp; | &ensp; |   1    |   2    |   3    |   4    |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
|   1    | &ensp; |   👑   | &ensp; | &ensp; | &ensp; |   1    | &ensp; |   👑   | &ensp; | &ensp; | &ensp; |   1    | &ensp; |   👑   | &ensp; | &ensp; |
|   2    | &ensp; | &ensp; |   👑   | &ensp; | &ensp; |   2    | &ensp; | &ensp; | &ensp; |   👑   | &ensp; |   2    | &ensp; | &ensp; | &ensp; |   👑   |
|   3    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   3    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   3    |   👑   | &ensp; | &ensp; | &ensp; |
|   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; | &ensp; |   4    | &ensp; | &ensp; | &ensp; | &ensp; |

</div>

@import "../dot/four-queen-solve5.dot" {.left13per .top0}

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">4</span>-皇后问题 回溯求解

---

<div class="left8 righta top-2 tighttable row1-4-column2-5-fullborder queen4-base2">

| &ensp; |   1    |   2    |   3    |   4    |
| :----: | :----: | :----: | :----: | :----: |
|   1    | &ensp; |   👑   | &ensp; | &ensp; |
|   2    | &ensp; | &ensp; | &ensp; |   👑   |
|   3    |   👑   | &ensp; | &ensp; | &ensp; |
|   4    | &ensp; | &ensp; |   👑   | &ensp; |

</div>

@import "../dot/four-queen-solve6.dot" {.left35per .top-20per}

<div class="top-2"></div>

结点 31 是答案结点，解$(2, 4, 1, 3)$

<!-- slide data-notes="" -->

##### 回溯法的一般描述

---

初始状态是第一个活结点，也是 E-结点

如果能从这个 E-结点移动到一个新结点，那么新结点将变成活结点和新的 E-结点，旧的 E-结点仍是一个活结点，但不是 E-结点了

如果不能移动到一个新结点，当前的 E-结点就“死”了，返回到最近被考察的活结点 (回溯)，这个活结点重新变成 E-结点

当找到了答案或者遍历了所有的活结点时，搜索过程结束

<!-- slide vertical=true data-notes="" -->

##### 回溯法的一般框架

---

```python {.left4 .line-numbers .top0 .bottom0}
def backtracking(n):
    x_1, x_2, ..., x_n
    k = 1
    while k > 0:
        if x_{k-1}的子结点中还有没检验过的x_k满足限界函数:
            if x_1, ..., x_k是一条抵达答案结点的路径
                print(x_1, ..., x_k)
            k = k + 1  # 考虑下一个结点
        else:
            k = k - 1  # 回溯到先前的结点
```

递归版，初始调用`backtracking_ref(1)`

```python {.left4 .line-numbers .top-1 .bottom0}
def backtracking_ref(k):
    global n, x_1, x_2, ..., x_n
    for x_k in 还有没检验过的x_{k-1}的子结点 and 满足限界函数:
        if x_1, ..., x_k是一条抵达答案结点的路径
            print(x_1, ..., x_k)
        递归调用backtracking_ref(k+1)
```

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">n</span>-皇后问题 回溯实现

---

@import "../codes/nqueen.py" {line_begin=0 line_end=52 .left4 .line-numbers .top0}

<!-- slide data-notes="" -->

##### 子集和数问题

---

输入：$n$个正数的集合$W = \{ w_1, w_2, \ldots, w_n\}$和正数$M$

输出：$W$中的和数等于$M$的所有子集

例 1：

- $n=4$，$(w_1, w_2, w_3, w_4) = (7, 11, 13, 24)$，$M = 31$
- 子集：$(7, 11, 13)$、$(7, 24)$

<div class="top2"></div>

例 2：

- $n=6$，$(w_1, w_2, w_3, w_4, w_5, w_6) = (5, 10, 12, 13, 15, 18)$，$M = 30$
- 子集：$(5, 10, 15)$、$(5, 12, 13)$、$(12,18)$

<!-- slide vertical=true data-notes="" -->

##### 子集和数问题

---

输入：$n$个正数的集合$W = \{ w_1, w_2, \ldots, w_n\}$和正数$M$

输出：$W$中的和数等于$M$的所有子集

解的表示：$n$-元组$(x_1, \ldots, x_n)$，$x_i \in \{0,1\}$表示是否选择这个数

限界函数：设$W$中元素已按升序排列，则有

$$
\begin{align*}
    \quad \sum_{i=1}^k w_i x_i + \sum_{i=k+1}^n w_i \ge M, \quad \sum_{i=1}^k w_i x_i + w_{k+1} \le M
\end{align*}
$$

<div class="top-2"></div>

即对$x_k$做出选择后，以下两种情形可以剪枝：

- 已选数之和 + 剩余所有数 < 目标值
- 已选数之和 + 剩余最小数 > 目标值

<!-- slide vertical=true data-notes="" -->

##### 子集和数问题

---

$n=6$，$(w_1, w_2, w_3, w_4, w_5, w_6) = (5, 10, 12, 13, 15, 18)$，$M = 30$

@import "../dot/sum-subset.dot" {.center .top0}

<div class="top-54per left46per fs18">

(已选数之和, 待选数下标, 剩余数之和)

</div>
