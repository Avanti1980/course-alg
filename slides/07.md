---
presentation:
  margin: 0
  center: false
  transition: "convex"
  enableSpeakerNotes: true
  slideNumber: "c/t"
  navigationMode: "linear"
---

@import "../css/font-awesome-4.7.0/css/font-awesome.css"
@import "../css/theme/solarized.css"
@import "../css/logo.css"
@import "../css/font.css"
@import "../css/color.css"
@import "../css/margin.css"
@import "../css/table.css"
@import "../css/main.css"
@import "../plugin/zoom/zoom.js"
@import "../plugin/customcontrols/plugin.js"
@import "../plugin/customcontrols/style.css"
@import "../plugin/chalkboard/plugin.js"
@import "../plugin/chalkboard/style.css"
@import "../plugin/menu/menu.js"

<!-- slide id="front-page" data-notes="" -->

<div class="bottom20"></div>

# 算法设计与分析

<hr class="width70 center">

## 全结点对最短路径

<div class="bottom8"></div>

### 计算机学院 &nbsp;&nbsp; 张腾

#### _tengzhang@hust.edu.cn_

<!-- slide vertical=true data-notes="" -->

##### 问题描述

---

给定带权有向图$\Gcal = (\Vcal, \Ecal)$，其中$\Vcal$为边集、$\Ecal$为点集

边上的权重由函数$w: \Ecal \mapsto \Rbb$给出，允许权重为负，但没有负环

对任意一对点$u,v \in \Vcal$，求$u$到$v$的最短路径

<div class="bottom4"></div>

---

<div class="bottom2"></div>

对于全结点对问题全部采用矩阵的表示形式更方便处理

设$n = |\Vcal|$，点的名字就是$1, 2, \ldots, n$

<div class="top-3"></div>

邻接矩阵$\Wv = [w_{ij}]_{1 \le i,j \le n}$，其中$w_{ij} = \begin{cases} 0, & i=j \\ w(i,j), & (i,j) \in \Ecal \\ \infty, & (i,j) \not \in \Ecal \end{cases}$

<!-- slide data-notes="" -->

##### 动态规划

---

$d_v^{(k)}$：从$s$到$v$经过不超过$k$条边的最短路径的长度

$$
\begin{align*}
    \quad d_v^{(k)} = \begin{cases} \infty, & k = 0 \\ \min \{ d_v^{(k-1)}, ~ \min_{u \ne v} \{ d_u^{(k-1)} + w(u,v) \} \}, & k \ge 1 \end{cases}
\end{align*}
$$

<div class="top2"></div>

$\ell_{ij}^{(m)}$：从$i$到$j$经过不超过$m$条边的最短路径的长度

$$
\begin{align*}
    \quad \ell_{ij}^{(m)} & = \begin{cases} \infty, & m = 0 \\ \min \{ \ell_{ij}^{(m-1)}, ~ \min_{k \ne i} \{ \ell_{ik}^{(m-1)} + w_{kj} \} \}, & m \ge 1 \end{cases} \\
    & = \begin{cases} \infty, & m = 0 \\ \min_k \{ \ell_{ik}^{(m-1)} + w_{kj} \}, & m \ge 1 \end{cases}
\end{align*}
$$

<!-- slide vertical=true data-notes="" -->

##### 动态规划 例子

---

<div class="top2"></div>

$$
\begin{align*}
    \quad \ell_{ij}^{(m)} & = \begin{cases} \infty, & m = 0 \\ \min_k \{ \ell_{ik}^{(m-1)} + w_{kj} \}, & m \ge 1 \end{cases} \\[5px]
    \Lv^{(0)} & = \begin{bmatrix}
        0 & \infty & \infty & \infty & \infty \\
        \infty & 0 & \infty & \infty & \infty \\
        \infty & \infty & 0 & \infty & \infty \\
        \infty & \infty & \infty & 0 & \infty \\
        \infty & \infty & \infty & \infty & 0
    \end{bmatrix} \\[5px]
    \Lv^{(1)} & = \Wv = \begin{bmatrix}
        0 & 3 & 8 & \infty & -4 \\
        \infty & 0 & \infty & 1 & 7 \\
        \infty & 4 & 0 & \infty & \infty \\
        2 & \infty & -5 & 0 & \infty \\
        \infty & \infty & \infty & 6 & 0
    \end{bmatrix}
\end{align*}
$$

@import "../tikz/sp-all.svg" {.lefta .right6 .width32 .top-45per}

<!-- slide vertical=true data-notes="" -->

##### 动态规划 例子

---

<div class="top2"></div>

$$
\begin{align*}
    \quad \ell_{ij}^{(m)} & = \begin{cases} \infty, & m = 0 \\ \min_k \{ \ell_{ik}^{(m-1)} + w_{kj} \}, & m \ge 1 \end{cases} \\[5px]
    \Lv^{(1)} & = \begin{bmatrix}
        0 & 3 & 8 & \infty & \class{blue}{-4} \\
        \infty & 0 & \infty & \class{yellow}{1} & 7 \\
        \infty & 4 & 0 & \infty & \infty \\
        \class{yellow}{2} & \infty & -5 & 0 & \infty \\
        \infty & \infty & \infty & \class{blue}{6} & 0
    \end{bmatrix}, ~ \Lv^{(2)} = \begin{bmatrix}
        0 & 3 & 8 & \class{blue}{2} & -4 \\
        \class{yellow}{3} & 0 & -4 & 1 & 7 \\
        \infty & 4 & 0 & 5 & 11 \\
        2 & -1 & -5 & 0 & -2 \\
        8 & \infty & 1 & 6 & 0
    \end{bmatrix} \\[5px]
    \Lv^{(3)} & = \begin{bmatrix}
        0 & 3 & -3 & 2 & -4 \\
        3 & 0 & -4 & 1 & -1 \\
        7 & 4 & 0 & 5 & 11 \\
        2 & -1 & -5 & 0 & -2 \\
        8 & 5 & 1 & 6 & 0
    \end{bmatrix}, ~ \Lv^{(4)} = \begin{bmatrix}
        0 & 1 & -3 & 2 & -4 \\
        3 & 0 & -4 & 1 & -1 \\
        7 & 4 & 0 & 5 & 3 \\
        2 & -1 & -5 & 0 & -2 \\
        8 & 5 & 1 & 6 & 0
    \end{bmatrix}
\end{align*}
$$

<!-- slide vertical=true data-notes="" -->

##### 动态规划 实现

---

<div class="top2"></div>

$$
\begin{align*}
    \quad \ell_{ij}^{(m)} = \begin{cases} \infty, & m = 0 \\ \min_k \{ \ell_{ik}^{(m-1)} + w_{kj} \}, & m \ge 1 \end{cases}
\end{align*}
$$

@import "../codes/sp-all-dp.py" {line_begin=0 line_end=13 .left4 .line-numbers .top0 .bottom1}

四重 for 循环时间复杂度$\Theta(n^4)$，二维表格空间复杂度$\Theta(n^2)$

<!-- slide data-notes="" -->

##### 动态规划 改进

---

矩阵乘法$\Cv = \Av \cdot \Bv$ _vs._ 最短路径$\Qv \leftarrow \Lv \circ \Wv$

```python {.left4 .line-numbers .top-1 .bottom2}
c =  [[0 for _ in range(n)] for _ in range(n)]
for i in range(n):
    for j in range(n):
        for k in range(n):
            c[i][j] = c[i][j] + a[i][k] * b[k][j]

q = [[l[i][j] for j in range(n)] for i in range(n)]
for i in range(n):
    for j in range(n):
        for k in range(n):
            q[i][j] = min(q[i][j], l[i][k] + w[k][j])
```

- 变量：$a$对应$l$、$b$对应$w$、$c$对应$q$
- 二元运算：高优先级$*$对应$+$、低优先级$+$对应$\min$

<div class="top2"></div>

我的启示 二元运算$\circ$也有结合律！

<!-- slide vertical=true data-notes="" -->

##### 动态规划 改进

---

注意初始时$\Lv^{(1)} = \Wv$，计算$\Lv^{(n)}$最外层循环迭代$\Theta(n)$轮

$$
\begin{align*}
    \quad \Lv^{(1)} & = \Wv \\
    \Lv^{(2)} & = \Lv^{(1)} \circ \Wv = \Wv^2 \\
    \Lv^{(3)} & = \Lv^{(2)} \circ \Wv = \Wv^3 \\
    \Lv^{(4)} & = \Lv^{(3)} \circ \Wv = \Wv^4 \\
\end{align*}
$$

利用结合律最外层循环只需$\Theta(\lg n)$轮，总时间复杂度$\Theta(n^3 \lg n)$

$$
\begin{align*}
    \quad \Lv^{(1)} & = \Wv \\
    \Lv^{(2)} & = \Wv^2 = \Lv^{(1)} \circ \Lv^{(1)} \\
    \Lv^{(4)} & = \Wv^4 = \Lv^{(2)} \circ \Lv^{(2)} \\
    \Lv^{(8)} & = \Wv^8 = \Lv^{(4)} \circ \Lv^{(4)}
\end{align*}
$$

<!-- slide vertical=true data-notes="" -->

##### 动态规划 改进

---

当$m \ge n-1$后$\Lv^{(m)}$不再变化，因此$m$不断乘$2$直至达到$n-1$

<div class="top-1"></div>

只需要$\Lv$矩阵，$\Wv$不用传进来，前驱矩阵的更新也有变化

@import "../codes/sp-all-dp.py" {line_begin=15 line_end=30 .left4 .line-numbers .top1 highlight=[1,3,5,8,15]}

<!-- slide data-notes="" -->

##### 动态规划 再改进

---

$d_v^{(k)}$：从$s$到$v${==经过不超过$k$条边==}的最短路径的长度

$$
\begin{align*}
    \quad d_v^{(k)} = \begin{cases} \infty, & k = 0 \\ \min \{ d_v^{(k-1)}, ~ \min_{u \ne v} \{ d_u^{(k-1)} + w(u,v) \} \}, & k \ge 1 \end{cases}
\end{align*}
$$

$\ell_{ij}^{(m)}$：从$i$到$j${==经过不超过$m$条边==}的最短路径的长度

$$
\begin{align*}
    \quad \ell_{ij}^{(m)} = \begin{cases} \infty, & m = 0 \\ \min_k \{ \ell_{ik}^{(m-1)} + w_{kj} \}, & m \ge 1 \end{cases}
\end{align*}
$$

$d_{ij}^{(k)}$：从$i$到$j${==中间结点属于集合$\{1,2, \ldots,k\}$==}的最短路径的长度

$$
\begin{align*}
    \quad d_{ij}^{k} = \begin{cases} w_{ij}, & k = 0 \\ \min_k \{ d_{ij}^{(k-1)}, d_{ik}^{(k-1)} + d_{kj}^{(k-1)} \}, & k \ge 1 \end{cases}
\end{align*}
$$

<!-- slide vertical=true data-notes="" -->

##### <span style="font-weight:900">Floyd-Warshall</span> 算法

---


